<section class="nd mt-2">
  <header class="nd__top">
    <app-button variant="outline" size="sm" type="button" (click)="back()">
      <i class="bi bi-arrow-left"></i> Voltar
    </app-button>

    <div class="nd__topRight" *ngIf="news">
      <span class="mini"><i class="bi bi-clock"></i> {{ news.created_at | date:'dd/MM/yyyy • HH:mm' }}</span>
    </div>
  </header>

  <div *ngIf="loading" class="nd__loading">
    <app-skeleton *ngFor="let s of [1,2,3,4]"></app-skeleton>
  </div>

  <div *ngIf="!loading && errorMsg" class="nd__empty">
    <div class="icon"><i class="bi bi-exclamation-triangle"></i></div>
    <h3>Ops…</h3>
    <p>{{ errorMsg }}</p>
    <app-button variant="outline" size="sm" (click)="fetch()">Tentar novamente</app-button>
  </div>

  <ng-container *ngIf="!loading && !errorMsg && news">
    <app-card class="nd__card">
      <div class="nd__tagRow">
        <span class="tag"><i class="bi bi-newspaper"></i> News</span>
        <div class="stats">
          <span><i class="bi bi-eye"></i> {{ news.view }}</span>
          <span><i class="bi bi-heart"></i> {{ news.like }}</span>
        </div>
      </div>

      <h1 class="nd__title">{{ news.title }}</h1>
      <p class="nd__body">{{ news.body }}</p>

      <div class="nd__actions">
        <app-button variant="primary" size="md" type="button" (click)="like()" [disabled]="liking">
          <i class="bi bi-heart-fill"></i> Curtir
        </app-button>
      </div>
    </app-card>

    <app-card class="nd__replyCard">
      <div class="replyHead">
        <h2>Comentários</h2>
        <span class=" ">Compartilhe feedback ou dúvidas</span>
      </div>

      <form [formGroup]="form" (ngSubmit)="submitReply()" class="replyForm">
        <textarea
          class="textarea"
          rows="4"
          formControlName="body"
          placeholder="Escreva um comentário…"
        ></textarea>

        <div class="replyMeta">
          <span class="err" *ngIf="bodyCtrl?.touched && bodyCtrl?.invalid">Mínimo 2 caracteres.</span>
          <span class="ok" *ngIf="replyOk"><i class="bi bi-check2-circle"></i> {{ replyOk }}</span>
          <span class="err" *ngIf="replyError"><i class="bi bi-exclamation-circle"></i> {{ replyError }}</span>
        </div>

        <div class="replyActions">
          <app-button variant="primary" size="md" type="submit" [loading]="replying" [disabled]="replying || form.invalid">
            <i class="bi bi-send"></i> Comentar
          </app-button>
        </div>
      </form>

      <div class="replies" *ngIf="replies.length > 0; else emptyReplies">
        <div class="reply" *ngFor="let r of replies; trackBy: trackReply">
          <div class="replyTop">
            <app-user-avatar [src]="r.user?.avatar_url" [name]="r.user?.name" [size]="34"></app-user-avatar>
            <div class="replyMeta2">
              <strong>{{ r.user?.name || 'Usuário' }}</strong>
              <span class=" ">{{ r.created_at | date:'dd/MM • HH:mm' }}</span>
            </div>
          </div>
          <p class="replyBody">{{ replyPreview(r) }}</p>
        </div>
      </div>

      <ng-template #emptyReplies>
        <div class="nd__emptyMini">
          <p class=" ">Ainda não há comentários. Seja o primeiro!</p>
        </div>
      </ng-template>

      <nav class="replyPager" *ngIf="repliesTotalPages > 1">
        <app-button variant="outline" size="sm" (click)="prevReplies()" [disabled]="repliesPage === 1">
          <i class="bi bi-chevron-left"></i>
        </app-button>
        <span class=" ">Página <strong>{{ repliesPage }}</strong> / {{ repliesTotalPages }}</span>
        <app-button variant="outline" size="sm" (click)="nextReplies()" [disabled]="repliesPage === repliesTotalPages">
          <i class="bi bi-chevron-right"></i>
        </app-button>
      </nav>
    </app-card>
  </ng-container>
</section>
